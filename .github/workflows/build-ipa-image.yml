name: Build IPA Image

on:
  push:
    branches:
      - custom_deploy
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    uses: ./.github/workflows/tests.yml

  build-ipa-image:
    needs: tests
    runs-on: ${{ matrix.runner }}
    outputs:
      amd64-9-stream-kernel-size: ${{ steps.build-info.outputs.amd64-9-stream-kernel-size }}
      amd64-9-stream-initramfs-size: ${{ steps.build-info.outputs.amd64-9-stream-initramfs-size }}
      amd64-9-stream-kernel-sha256: ${{ steps.build-info.outputs.amd64-9-stream-kernel-sha256 }}
      amd64-9-stream-initramfs-sha256: ${{ steps.build-info.outputs.amd64-9-stream-initramfs-sha256 }}
      arm64-9-stream-kernel-size: ${{ steps.build-info.outputs.arm64-9-stream-kernel-size }}
      arm64-9-stream-initramfs-size: ${{ steps.build-info.outputs.arm64-9-stream-initramfs-size }}
      arm64-9-stream-kernel-sha256: ${{ steps.build-info.outputs.arm64-9-stream-kernel-sha256 }}
      arm64-9-stream-initramfs-sha256: ${{ steps.build-info.outputs.arm64-9-stream-initramfs-sha256 }}
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
            release: 9-stream
            network_element: dhclient-systemd
          - arch: arm64
            runner: ubuntu-24.04-arm
            release: 9-stream
            network_element: dhclient-systemd

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            debootstrap \
            dosfstools \
            gdisk \
            kpartx \
            libffi-dev \
            libssl-dev \
            parted \
            python3-dev \
            python3-pip \
            python3-yaml \
            qemu-utils \
            util-linux

      - name: Install diskimage-builder and ironic-python-agent-builder
        run: |
          pip install --user diskimage-builder ironic-python-agent-builder
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install current IPA source
        run: |
          pip install --user -e .

      - name: Copy custom DIB elements
        run: |
          mkdir -p $HOME/.local/share/ironic-python-agent-builder/dib
          cp -vr .github/dib-elements/* $HOME/.local/share/ironic-python-agent-builder/dib/

      - name: Build IPA ramdisk image (amd64)
        if: matrix.arch == 'amd64'
        env:
          DIB_RELEASE: "${{ matrix.release }}"
          DIB_CHECKSUM: "sha256"
          DIB_DHCP_TIMEOUT: "180"
          DIB_PYTHON_EXEC: "/usr/bin/python3"
          DIB_IPA_ENABLE_RESCUE: false
          DIB_DEV_USER_USERNAME: "rescue"
          DIB_DEV_USER_PASSWORD: "rescue"
          DIB_DEV_USER_PWDLESS_SUDO: "yes"
          DIB_REPOLOCATION_ironic_python_agent: "${{ github.workspace }}"
          DIB_REPOREF_ironic_python_agent: "HEAD"
          DIB_EXTRA_PACKAGES: "jq yq mdadm lvm2 curl qemu-img parted util-linux squashfs-tools xfsprogs dosfstools grub2-efi-x64 grub2-pc grub2-tools"
        run: |
          ironic-python-agent-builder \
            -o ipa-amd64-${{ matrix.release }} \
            -e extra-hardware \
            -e devuser \
            -e ${{ matrix.network_element }} \
            -e packages-install \
            -e crane \
            -e custom-deploy \
            -e build-report \
            --extra-args="-a amd64" \
            --release ${{ matrix.release }} centos

      - name: Build IPA ramdisk image (arm64)
        if: matrix.arch == 'arm64'
        env:
          DIB_RELEASE: "${{ matrix.release }}"
          DIB_CHECKSUM: "sha256"
          DIB_DHCP_TIMEOUT: "180"
          DIB_PYTHON_EXEC: "/usr/bin/python3"
          DIB_IPA_ENABLE_RESCUE: false
          DIB_DEV_USER_USERNAME: "rescue"
          DIB_DEV_USER_PASSWORD: "rescue"
          DIB_DEV_USER_PWDLESS_SUDO: "yes"
          DIB_REPOLOCATION_ironic_python_agent: "${{ github.workspace }}"
          DIB_REPOREF_ironic_python_agent: "HEAD"
          DIB_EXTRA_PACKAGES: "jq yq mdadm lvm2 curl qemu-img parted util-linux squashfs-tools xfsprogs dosfstools grub2-efi-aa64 grub2-tools"
        run: |
          ironic-python-agent-builder \
            -o ipa-arm64-${{ matrix.release }} \
            -e extra-hardware \
            -e devuser \
            -e ${{ matrix.network_element }} \
            -e packages-install \
            -e crane \
            -e custom-deploy \
            -e build-report \
            --extra-args="-a arm64 --no-tmpfs" \
            --release ${{ matrix.release }} centos

      - name: Verify image artifacts
        run: |
          ls -lh ipa-${{ matrix.arch }}-${{ matrix.release }}.kernel ipa-${{ matrix.arch }}-${{ matrix.release }}.initramfs

      - name: Capture build information
        id: build-info
        run: |
          KERNEL_SIZE=$(ls -lh ipa-${{ matrix.arch }}-${{ matrix.release }}.kernel | awk '{print $5}')
          INITRAMFS_SIZE=$(ls -lh ipa-${{ matrix.arch }}-${{ matrix.release }}.initramfs | awk '{print $5}')
          KERNEL_SHA256=$(sha256sum ipa-${{ matrix.arch }}-${{ matrix.release }}.kernel | awk '{print $1}')
          INITRAMFS_SHA256=$(sha256sum ipa-${{ matrix.arch }}-${{ matrix.release }}.initramfs | awk '{print $1}')
          echo "${{ matrix.arch }}-${{ matrix.release }}-kernel-size=${KERNEL_SIZE}" >> $GITHUB_OUTPUT
          echo "${{ matrix.arch }}-${{ matrix.release }}-initramfs-size=${INITRAMFS_SIZE}" >> $GITHUB_OUTPUT
          echo "${{ matrix.arch }}-${{ matrix.release }}-kernel-sha256=${KERNEL_SHA256}" >> $GITHUB_OUTPUT
          echo "${{ matrix.arch }}-${{ matrix.release }}-initramfs-sha256=${INITRAMFS_SHA256}" >> $GITHUB_OUTPUT

      - name: Rename artifacts to standard names
        run: |
          mv ipa-${{ matrix.arch }}-${{ matrix.release }}.kernel ipa-${{ matrix.arch }}.kernel
          mv ipa-${{ matrix.arch }}-${{ matrix.release }}.initramfs ipa-${{ matrix.arch }}.initramfs

      - name: Upload IPA artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ipa-${{ matrix.arch }}
          path: |
            ipa-${{ matrix.arch }}.kernel
            ipa-${{ matrix.arch }}.initramfs
          retention-days: 1

  deploy-to-pages:
    runs-on: ubuntu-latest
    needs: build-ipa-image
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Prepare pages directory
        run: |
          mkdir -p _site
          cp artifacts/ipa-amd64/* _site/
          cp artifacts/ipa-arm64/* _site/
          ls -la _site/

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v4

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Delete pages artifact
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts \
            --jq '.artifacts[] | select(.name == "github-pages") | .id' | \
          xargs -I {} gh api repos/${{ github.repository }}/actions/artifacts/{} -X DELETE || true

  build-summary:
    runs-on: ubuntu-latest
    needs: [build-ipa-image, deploy-to-pages]
    if: always()

    steps:
      - name: Generate aggregated build summary
        run: |
          PAGES_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

          echo "# IPA Multi-Architecture Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **User**: rescue/rescue" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | Release | Kernel | Initramfs |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|---------|--------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| amd64 | 9-stream | ${{ needs.build-ipa-image.outputs.amd64-9-stream-kernel-size }} | ${{ needs.build-ipa-image.outputs.amd64-9-stream-initramfs-size }} |" >> $GITHUB_STEP_SUMMARY
          echo "| arm64 | 9-stream | ${{ needs.build-ipa-image.outputs.arm64-9-stream-kernel-size }} | ${{ needs.build-ipa-image.outputs.arm64-9-stream-initramfs-size }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## SHA256 Checksums" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | SHA256 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ipa-amd64.kernel | \`${{ needs.build-ipa-image.outputs.amd64-9-stream-kernel-sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ipa-amd64.initramfs | \`${{ needs.build-ipa-image.outputs.amd64-9-stream-initramfs-sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ipa-arm64.kernel | \`${{ needs.build-ipa-image.outputs.arm64-9-stream-kernel-sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ipa-arm64.initramfs | \`${{ needs.build-ipa-image.outputs.arm64-9-stream-initramfs-sha256 }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Download Links (GitHub Pages)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | Kernel | Initramfs |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| amd64 | [ipa-amd64.kernel](${PAGES_URL}/ipa-amd64.kernel) | [ipa-amd64.initramfs](${PAGES_URL}/ipa-amd64.initramfs) |" >> $GITHUB_STEP_SUMMARY
          echo "| arm64 | [ipa-arm64.kernel](${PAGES_URL}/ipa-arm64.kernel) | [ipa-arm64.initramfs](${PAGES_URL}/ipa-arm64.initramfs) |" >> $GITHUB_STEP_SUMMARY
